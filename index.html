<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta http-equiv="Cache-Control" content="no-cache">
    <meta name="theme-color" content="#0a0a0a">
    <title>BLACK STUDIO</title>
    <link rel="manifest" href="manifest.json">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0a0a0a; 
            color: #fff;
            min-height: 100vh;
            padding: 20px;
            padding-bottom: 100px;
        }
        .header {
            text-align: center;
            padding: 20px 0;
        }
        .header h1 { 
            font-size: 28px; 
            font-weight: 800;
            letter-spacing: 2px;
        }
        .header span { color: #e94560; }
        .card {
            background: #1a1a2e;
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 15px;
            border: 1px solid #2a2a3e;
        }
        .card-title {
            font-size: 12px;
            text-transform: uppercase;
            color: #8b8b9a;
            margin-bottom: 12px;
            letter-spacing: 1px;
        }
        select, input, textarea, button {
            width: 100%;
            padding: 16px;
            border-radius: 12px;
            border: 1px solid #2a2a3e;
            background: #0f0f1a;
            color: #fff;
            font-size: 16px;
            margin-bottom: 10px;
        }
        button {
            background: linear-gradient(135deg, #e94560 0%, #ff6b6b 100%);
            border: none;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        button:disabled {
            background: #2a2a3e;
            color: #666;
        }
        .preview {
            width: 100%;
            aspect-ratio: 1;
            background: #0f0f1a;
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 48px;
        }
        .preview img {
            max-width: 100%;
            max-height: 100%;
            border-radius: 16px;
        }
        .status {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: #1a1a2e;
            padding: 20px;
            border-top: 1px solid #2a2a3e;
            text-align: center;
        }
        #progress {
            height: 4px;
            background: #2a2a3e;
            border-radius: 2px;
            margin-bottom: 10px;
        }
        #progressBar {
            height: 100%;
            background: #e94560;
            width: 0%;
            transition: width 0.3s;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>BLACK <span>STUDIO</span></h1>
    </div>

    <div class="card">
        <div class="card-title">üì∏ –§–æ—Ç–æ –ª–∏—Ü–∞</div>
        <input type="file" id="facePhoto" accept="image/*" capture="user">
    </div>

    <div class="card">
        <div class="card-title">‚öôÔ∏è –î–≤–∏–∂–æ–∫</div>
        <select id="engine">
            <option value="seedream">Seedream 4.5</option>
            <option value="luma_flash">Luma Photon Flash</option>
            <option value="pulid">PuLID</option>
        </select>
    </div>

    <div class="card">
        <div class="card-title">üí° –û–ø–∏—Å–∞–Ω–∏–µ</div>
        <textarea id="prompt" rows="3" placeholder="–û–ø–∏—à–∏—Ç–µ –∂–µ–ª–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç..."></textarea>
    </div>

    <button id="generateBtn" onclick="generate()">üöÄ –ì–ï–ù–ï–†–ò–†–û–í–ê–¢–¨</button>

    <div class="card">
        <div class="card-title">üëÅÔ∏è –†–µ–∑—É–ª—å—Ç–∞—Ç</div>
        <div class="preview" id="preview">üì∑</div>
    </div>

    <div class="status">
        <div id="progress"><div id="progressBar"></div></div>
        <div id="statusText">–ì–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ</div>
    </div>

    <script>
        const GAS_URL = 'https://script.google.com/macros/s/AKfycbz0ZWydDdLGDublWZJp6mmpiCmFtwpthtu57lR0gp2ep2idgaQRQyhe1wreUdlD3XWUsg/exec?v=3';

        function updateStatus(text, percent) {
            document.getElementById('statusText').textContent = text;
            document.getElementById('progressBar').style.width = percent + '%';
        }

       function generate() {
    const btn = document.getElementById('generateBtn');
    const fileInput = document.getElementById('facePhoto');
    const prompt = document.getElementById('prompt').value;
    const engine = document.getElementById('engine').value;

    if (!fileInput.files[0]) {
        alert('üì∏ –í—ã–±–µ—Ä–∏—Ç–µ —Ñ–æ—Ç–æ –ª–∏—Ü–∞');
        return;
    }

    btn.disabled = true;
    updateStatus('üì§ –°–∂–∞—Ç–∏–µ —Ñ–æ—Ç–æ...', 5);

    // –°–∂–∏–º–∞–µ–º —Ñ–æ—Ç–æ –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π
    const file = fileInput.files[0];
    const img = new Image();
    const reader = new FileReader();
    
    reader.onload = function(e) {
        img.onload = function() {
            // –°–æ–∑–¥–∞–µ–º canvas –¥–ª—è —Å–∂–∞—Ç–∏—è
            const canvas = document.createElement('canvas');
            const maxSize = 400; // –ú–∞–∫—Å–∏–º—É–º 400px –ø–æ —à–∏—Ä–∏–Ω–µ/–≤—ã—Å–æ—Ç–µ
            let width = img.width;
            let height = img.height;
            
            if (width > height) {
                if (width > maxSize) {
                    height *= maxSize / width;
                    width = maxSize;
                }
            } else {
                if (height > maxSize) {
                    width *= maxSize / height;
                    height = maxSize;
                }
            }
            
            canvas.width = width;
            canvas.height = height;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0, width, height);
            
            // –ü–æ–ª—É—á–∞–µ–º base64 —Å –Ω–∏–∑–∫–∏–º –∫–∞—á–µ—Å—Ç–≤–æ–º (0.6 = 60%)
            const base64 = canvas.toDataURL('image/jpeg', 0.6).split(',')[1];
            
            updateStatus('üé® –û—Ç–ø—Ä–∞–≤–∫–∞...', 30);
            sendToServer(base64, prompt, engine, btn);
        };
        img.src = e.target.result;
    };
    reader.readAsDataURL(file);
}

function sendToServer(base64, prompt, engine, btn) {
    const script = document.createElement('script');
    const cb = 'cb' + Date.now();
    
    window[cb] = function(result) {
        delete window[cb];
        if (script.parentNode) document.head.removeChild(script);
        
        if (result.error) {
            alert('‚ùå –û—à–∏–±–∫–∞: ' + result.error);
            updateStatus('–û—à–∏–±–∫–∞', 0);
        } else if (result.imageUrl) {
            document.getElementById('preview').innerHTML = '<img src="' + result.imageUrl + '">';
            updateStatus('‚úÖ –ì–æ—Ç–æ–≤–æ!', 100);
        }
        btn.disabled = false;
    };
    
    // –¢–∞–π–º–∞—É—Ç 25 —Å–µ–∫—É–Ω–¥
    setTimeout(function() {
        if (window[cb]) {
            delete window[cb];
            if (script.parentNode) document.head.removeChild(script);
            alert('‚è±Ô∏è –¢–∞–π–º–∞—É—Ç - –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑');
            updateStatus('–¢–∞–π–º–∞—É—Ç', 0);
            btn.disabled = false;
        }
    }, 25000);
    
    const data = {
        action: 'generate',
        engine: engine,
        prompt: prompt,
        faceImage: base64
    };
    
    script.src = GAS_URL + '&callback=' + cb + '&data=' + encodeURIComponent(JSON.stringify(data));
    document.head.appendChild(script);
}
    </script>
</body>
</html>
