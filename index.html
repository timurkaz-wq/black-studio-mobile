<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#0a0a0a">
    <title>BLACK STUDIO</title>
    <link rel="manifest" href="manifest.json">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0a0a0a; 
            color: #fff;
            min-height: 100vh;
            padding: 20px;
            padding-bottom: 100px;
        }
        .header {
            text-align: center;
            padding: 20px 0;
        }
        .header h1 { 
            font-size: 28px; 
            font-weight: 800;
            letter-spacing: 2px;
        }
        .header span { color: #e94560; }
        .version {
            text-align: center;
            color: #666;
            font-size: 12px;
            margin-bottom: 20px;
        }
        .card {
            background: #1a1a2e;
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 15px;
            border: 1px solid #2a2a3e;
        }
        .card-title {
            font-size: 12px;
            text-transform: uppercase;
            color: #8b8b9a;
            margin-bottom: 12px;
            letter-spacing: 1px;
        }
        select, input, textarea, button {
            width: 100%;
            padding: 16px;
            border-radius: 12px;
            border: 1px solid #2a2a3e;
            background: #0f0f1a;
            color: #fff;
            font-size: 16px;
            margin-bottom: 10px;
            outline: none;
        }
        select:focus, textarea:focus {
            border-color: #e94560;
        }
        button {
            background: linear-gradient(135deg, #e94560 0%, #ff6b6b 100%);
            border: none;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            cursor: pointer;
            transition: transform 0.1s;
        }
        button:active {
            transform: scale(0.98);
        }
        button:disabled {
            background: #2a2a3e;
            color: #666;
            transform: none;
        }
        input[type="file"] {
            padding: 12px;
            font-size: 14px;
        }
        .preview {
            width: 100%;
            aspect-ratio: 1;
            background: #0f0f1a;
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 48px;
            overflow: hidden;
        }
        .preview img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }
        .status {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: #1a1a2e;
            padding: 20px;
            border-top: 1px solid #2a2a3e;
            text-align: center;
            z-index: 100;
        }
        #progress {
            height: 4px;
            background: #2a2a3e;
            border-radius: 2px;
            margin-bottom: 10px;
            overflow: hidden;
        }
        #progressBar {
            height: 100%;
            background: #e94560;
            width: 0%;
            transition: width 0.3s;
        }
        .hidden { display: none !important; }
    </style>
</head>
<body>
    <div class="header">
        <h1>BLACK <span>STUDIO</span></h1>
    </div>
    <div class="version">V130.2 Mobile</div>

    <div class="card">
        <div class="card-title">üì∏ –§–æ—Ç–æ –ª–∏—Ü–∞ (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</div>
        <input type="file" id="facePhoto" accept="image/*" capture="user">
    </div>

    <div class="card">
        <div class="card-title">‚öôÔ∏è –î–≤–∏–∂–æ–∫ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏</div>
        <select id="engine">
            <option value="seedream">Seedream 4.5 (ByteDance)</option>
            <option value="seedream_segmind">Seedream 4.5 (Segmind)</option>
            <option value="qwen_group">Qwen Group Photo</option>
            <option value="luma_flash">Luma Photon Flash</option>
            <option value="pulid">PuLID (Flux Face Swap)</option>
            <option value="aurora">Aurora (Grok)</option>
            <option value="faceswap">Face Swap</option>
            <option value="outfitswap">Outfit Swap</option>
        </select>
    </div>

    <div class="card">
        <div class="card-title">üí° –û–ø–∏—Å–∞–Ω–∏–µ —Å—Ü–µ–Ω—ã</div>
        <textarea id="prompt" rows="3" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: Professional beauty portrait, studio lighting, dark background..."></textarea>
    </div>

    <button id="generateBtn" onclick="generate()">üöÄ –ì–ï–ù–ï–†–ò–†–û–í–ê–¢–¨</button>

    <div class="card">
        <div class="card-title">üëÅÔ∏è –†–µ–∑—É–ª—å—Ç–∞—Ç</div>
        <div class="preview" id="preview">üì∑</div>
    </div>

    <div class="status">
        <div id="progress"><div id="progressBar"></div></div>
        <div id="statusText">–ì–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ</div>
    </div>

    <script>
        // –í–ê–® URL Google Apps Script
        const GAS_URL = 'https://script.google.com/macros/s/AKfycbz0ZWydDdLGDublWZJp6mmpiCmFtwpthtu57lR0gp2ep2idgaQRQyhe1wreUdlD3XWUsg/exec';

        async function generate() {
            const btn = document.getElementById('generateBtn');
            const fileInput = document.getElementById('facePhoto');
            const prompt = document.getElementById('prompt').value;
            const engine = document.getElementById('engine').value;

            if (!fileInput.files[0]) {
                alert('üì∏ –í—ã–±–µ—Ä–∏—Ç–µ —Ñ–æ—Ç–æ –ª–∏—Ü–∞');
                fileInput.click();
                return;
            }

            btn.disabled = true;
            updateStatus('üì§ –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–æ—Ç–æ...', 10);

            try {
                // –ß–∏—Ç–∞–µ–º —Ñ–∞–π–ª
                const file = fileInput.files[0];
                const base64 = await fileToBase64(file);
                
                updateStatus('‚öôÔ∏è –û–±—Ä–∞–±–æ—Ç–∫–∞...', 30);
                
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ —Å–µ—Ä–≤–µ—Ä
                const response = await fetch(GAS_URL, {
                    method: 'POST',
                    mode: 'cors',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'generate',
                        engine: engine,
                        prompt: prompt,
                        faceImage: base64
                    })
                });

                updateStatus('üé® –ì–µ–Ω–µ—Ä–∞—Ü–∏—è...', 60);

                const result = await response.json();
                
                if (result.error) {
                    throw new Error(result.error);
                }

                if (!result.imageUrl) {
                    throw new Error('–°–µ—Ä–≤–µ—Ä –Ω–µ –≤–µ—Ä–Ω—É–ª –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ');
                }

                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
                const preview = document.getElementById('preview');
                preview.innerHTML = `<img src="${result.imageUrl}" alt="Generated">`;
                
                updateStatus('‚úÖ –ì–æ—Ç–æ–≤–æ!', 100);

            } catch (err) {
                console.error(err);
                alert('‚ùå –û—à–∏–±–∫–∞: ' + err.message);
                updateStatus('‚ùå –û—à–∏–±–∫–∞: ' + err.message, 0);
            } finally {
                btn.disabled = false;
            }
        }

        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    // –£–±–∏—Ä–∞–µ–º –ø—Ä–µ—Ñ–∏–∫—Å "data:image/jpeg;base64,"
                    const base64 = e.target.result.split(',')[1];
                    resolve(base64);
                };
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        function updateStatus(text, percent) {
            document.getElementById('statusText').textContent = text;
            document.getElementById('progressBar').style.width = percent + '%';
        }

        // –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º Service Worker –¥–ª—è PWA
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js').catch(console.error);
        }
    </script>
</body>
</html>
